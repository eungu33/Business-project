# Multi-output LSTM 기반 예측 시스템 전체 파이프라인 보고서

---

## 1. 데이터 수집 및 전처리

본 예측 시스템은 30초 단위의 시계열 센서 데이터를 기반으로 합니다.  
원본 데이터는 `processed_D.csv` 파일에 저장되어 있으며, 이를 바탕으로 예측에 적합한 형태로 전처리 과정을 수행하였습니다.

- 모든 데이터를 5분 단위로 리샘플링
  - 유량 관련 컬럼: 누적합(sum) 방식 집계
  - 수위, 압력 등 나머지 컬럼: 평균(mean) 방식 처리
- 시계열 데이터 불연속성 방지를 위해 `ffill()` 및 `bfill()`을 활용한 결측치 보간

---

## 2. CatBoost 및 SHAP 기반 중요 피처 선정

### 시계열 기반 파생 피처 생성

- **파생 피처 종류:**
  - lag: 이전 시점 값 (`lag1`, `lag2`, ...)
  - diff: 차분 (`diff1`, `diff2`, ...)
  - pct_change: 비율 변화량
  - rolling mean / std: 이동 평균, 표준편차
  - Fourier (sin/cos): 주기성 인코딩
  - 시간 기반 피처: 시간, 요일, 주말 여부 등

### 중요 피처 선정 절차

- 각 타겟 변수별 CatBoostRegressor 단일 회귀 모델 학습
- 피처별 중요도 계산 후 상위 100개 피처 선별
- 선별된 피처를 바탕으로 SHAP 분석 수행
- SHAP 분석 대상 타겟:
  - `D_배수지_유출유량2`
  - `D_배수지_수위7_m3`
  - `D_배수지_수위8_m3`
- 각 타겟별 SHAP 상위 30개 피처의 합집합으로 최종 입력 피처 집합 구성

> 다중 타겟 LSTM 모델의 입력 차원 축소 및 예측 성능 극대화를 위한 중요한 전처리 단계

---

## 3. 입력(X) 및 출력(Y) 구성

- 선정된 입력 피처와 3개 타겟 변수 병합
- 결측치 존재 구간 제거
- 입력(X)과 출력(Y) 분리 후 정규화 수행

---

## 4. 데이터 정규화

- 모델 안정성 및 학습 속도 향상을 위해 `MinMaxScaler` 적용
- `X`와 `Y` 모두 정규화
- 학습된 스케일러 객체(`scaler_X`, `scaler_y`)와 함께 저장하여 예측값 역변환에 활용

---

## 5. LSTM 모델 구성 및 학습 전략

- PyTorch 기반 LSTM 아키텍처 구현
- 주요 구조:
  - 양방향 LSTM (BiLSTM)
  - Batch Normalization 및 Dropout 적용
  - 마지막 시점 출력 → Fully Connected Layer → 3개 타겟 동시 예측
- 손실 함수: MSELoss
- 조기 종료(Early Stopping) 적용: validation loss 개선 없으면 일정 patience 후 학습 종료

---

## 6. Grid Search를 통한 하이퍼파라미터 최적화

- 탐색 대상 하이퍼파라미터:
  - hidden_dim, num_layers, dropout, learning_rate, seq_length, batch_size
- 모든 조합에 대해 학습 반복 수행
- 기준 타겟(`D_배수지_유출유량2`) validation loss 기준 최적 모델 선정

| 지표                 | 값                           |
|--------------------|-----------------------------|
| Best Val Loss       | 0.0021                      |
| Best Params         | `{'hidden_dim': 64, 'num_layers': 2, 'dropout': 0.2, 'lr': 0.001, 'seq_length': 24, 'batch_size': 32}` |

---

## 7. 모델 평가 및 시각화

- Train, Validation, Test 구간별 성능 평가
- 평가 지표: RMSE, MAE, R²

| 구분       | 타겟                   | RMSE  | MAE    | R²     |
|------------|------------------------|-------|--------|--------|
| **Train**  | D_배수지_유출유량2      | 3.91  | 2.80   | 0.9337 |
|            | D_배수지_수위7_m3       | 93.33 | 83.77  | 0.9749 |
|            | D_배수지_수위8_m3       | 100.89| 90.38  | 0.9714 |
| **Validation** | D_배수지_유출유량2   | 3.90  | 2.81   | 0.9249 |
|            | D_배수지_수위7_m3       | 101.24| 96.78  | 0.9432 |
|            | D_배수지_수위8_m3       | 107.49| 102.76 | 0.9375 |
| **Test**   | D_배수지_유출유량2      | 3.89  | 2.83   | 0.9119 |
|            | D_배수지_수위7_m3       | 103.58| 101.13 | 0.9163 |
|            | D_배수지_수위8_m3       | 111.71| 108.00 | 0.9092 |

- 예측 결과 시계열 그래프로 시각화
  - 전체 기간
  - 1일 단위 확대
  - 1시간 단위 확대  
실제값과 예측값 추세 비교

---

## 8. 예측 결과 후처리 및 저장

- 예측값 역정규화 진행 (MinMaxScaler 역변환)
- 수위 컬럼: 체적(m³) → 백분율(%) 환산
  - 배수지별 탱크 용량 정보가 담긴 `volume_map` 적용
- 최종 결과 `1_Multi_lstm_pred_D.csv` 파일로 저장 (실제값 및 예측값 포함)
